
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>qprop.f &#8212; Mark Drela Tools</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="qcget.f" href="qcget_f.html" />
    <link rel="prev" title="QProp Algorithms" href="qprop-algorithms.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/lpp.gif" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Mark Drela Tools</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Refactoring Mark Drelaâ€™s Tools
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../xfoil/xfoil.html">
   XFoil - Airfoil Analysis Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="qprop.html">
   QPROP: Propeller Analysis Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="qprop-algorithms.html">
   QProp Algorithms
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   qprop.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="qcget_f.html">
   qcget.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tqcalc_f.html">
   tqcalc.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cdfun_f.html">
   cdfun.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gvcalc_f.html">
   gvcalc.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="spline_f.html">
   spline.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="io_f.html">
   io.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bnsolv_f.html">
   bnsolv.f
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/qprop/qprop_f.rst"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rblack42/math-magik-drela"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rblack42/math-magik-drela/issues/new?title=Issue%20on%20page%20%2Fqprop/qprop_f.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>qprop.f</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="qprop-f">
<h1>qprop.f<a class="headerlink" href="#qprop-f" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>C***********************************************************************
C    Module:  qprop.f
C 
C    Copyright (C) 2005 Mark Drela 
C 
C    This program is free software; you can redistribute it and/or modify
C    it under the terms of the GNU General Public License as published by
C    the Free Software Foundation; either version 2 of the License, or
C    (at your option) any later version.
C
C    This program is distributed in the hope that it will be useful,
C    but WITHOUT ANY WARRANTY; without even the implied warranty of
C    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
C    GNU General Public License for more details.
C
C    You should have received a copy of the GNU General Public License
C    along with this program; if not, write to the Free Software
C    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
C***********************************************************************

      PROGRAM QPROP
C--------------------------------------------------------
C     Propeller/motor performance program
C     Version 1.20   12 Mar 06
C
C     Usage:
C
C % qprop propfile motorfile Vel Rpm Volt dBeta    (single-point)
C
C % qprop propfile motorfile Vel1,Vel2,dVel Rpm Volt dBeta  (1-param multi-point)
C
C % qprop propfile motorfile Vel1,Vel2/NVel Rpm Volt dBeta  (1-param multi-point)
C
C % qprop propfile motorfile Vel1,Vel2/NVel Rpm Volt1,Volt2,dVolt dBeta  
C                                                           (2-param multi-point)
C
C % qprop propfile motorfile runfile               (multi-point)
C
C
C--------------------------------------------------------
      IMPLICIT REAL (A-H,M,O-Z)
C
C---- input radial quantities (from propfile)
      PARAMETER (IRDIM=81)
      REAL WORK(IRDIM)
      REAL RB(IRDIM), CB(IRDIM), BB(IRDIM)
      REAL CL0B(IRDIM), DCLDAB(IRDIM), CLMINB(IRDIM), CLMAXB(IRDIM)
      REAL CD0B(IRDIM), CD2UB(IRDIM), CD2LB(IRDIM), CLCD0B(IRDIM)
      REAL REREFB(IRDIM), REEXPB(IRDIM), MCRITB(IRDIM)
C
C---- radial quantities interpolated to computational stations
      PARAMETER (IDIM=25)
      REAL R(IDIM), C(IDIM), B(IDIM), DR(IDIM)
      REAL CL0(IDIM), DCLDA(IDIM), CLMIN(IDIM), CLMAX(IDIM)
      REAL CD0(IDIM), CD2U(IDIM), CD2L(IDIM), CLCD0(IDIM)
      REAL REREF(IDIM), REEXP(IDIM), MCRIT(IDIM)
      REAL VA(IDIM), VT(IDIM), CL(IDIM), CD(IDIM)
      LOGICAL STALL(IDIM)
C
      REAL TP_C(IDIM), TP_B(IDIM),
     &amp;     QP_C(IDIM), QP_B(IDIM)
C
C---- motor parameters
      PARAMETER (NMPDIM=10)
      REAL PARMOT(NMPDIM)
      CHARACTER*32 PMLAB(NMPDIM)
C
C---- various character variables
      CHARACTER*1 CHARF, ANS
      CHARACTER*80 PNAME, MNAME
      CHARACTER*80 ARGP1, ARGP2, ARGP3, ARGP4, ARGP5,
     &amp;             ARGP6, ARGP7, ARGP8, ARGP9, ARGP10
      CHARACTER*80 FILNAM
      CHARACTER*128 LINE
C
      LOGICAL LRDUMP
      LOGICAL LRPMSET,
     &amp;        LVOLTSET,
     &amp;        LTHRUSET,
     &amp;        LTORQSET,
     &amp;        LAMPSSET,
     &amp;        LPELESET
      LOGICAL ERROR
C
      INCLUDE &#39;QDEF.INC&#39;
C
C---- input receiving arrays
      REAL RVAL(15)
      INTEGER IVAL(15)
C
      DATA PI / 3.14159265 /
ccc      DATA EPS / 1.0E-6 /
      DATA EPS / 1.0E-8 /
C
      DATA VERSION / 1.22 /

C---- default Mcrit
      MCRIT0 = 0.70
C
C---- get Unix command-line arguments, if any
      CALL GETARG0(1,ARGP1)
      CALL GETARG0(2,ARGP2)
      CALL GETARG0(3,ARGP3)
      CALL GETARG0(4,ARGP4)
      CALL GETARG0(5,ARGP5)
      CALL GETARG0(6,ARGP6)
      CALL GETARG0(7,ARGP7)
      CALL GETARG0(8,ARGP8)
      CALL GETARG0(9,ARGP9)
      CALL GETARG0(10,ARGP10)
C
      IF(ARGP1.EQ.&#39; &#39;) THEN
       WRITE(*,1005)
 1005  FORMAT(
     &amp; /&#39; QPROP usage:&#39;
     &amp;//&#39; % qprop propfile motorfile Vel Rpm &#39;,
     &amp;             &#39;[ Volt dBeta Thrust Torque Amps Pele ]&#39;,
     &amp;  &#39;   (single-point)&#39;
     &amp;//&#39; % qprop propfile motorfile Vel1,Vel2,dVel Rpm [&quot;]           &#39;,
     &amp;  &#39;   (multi-point 1-parameter sweep over Vel, Rpm set)&#39;
     &amp;//&#39; % qprop propfile motorfile Vel1,Vel2,dVel 0 Volt [&quot;]        &#39;,
     &amp;  &#39;   (multi-point 1-parameter sweep over Vel, Volt set)&#39;
     &amp;//&#39; % qprop propfile motorfile Vel1,Vel2,dVel Rpm1,Rpm2,dRpm [&quot;]&#39;,
     &amp;  &#39;   (multi-point 2-parameter sweep over Vel and Rpm)&#39;
     &amp;//&#39; % qprop propfile motorfile runfile                          &#39;,
     &amp;  &#39;   (multi-point, via file specification)&#39;
     &amp;       )
       WRITE(*,*)
       WRITE(*,*) &#39;Run with default inputs?  Y&#39;
       READ(*,1000) ANS
       IF(INDEX(&#39;Nn&#39;,ANS) .NE. 0) STOP
       WRITE(*,*) 
      ENDIF
C
C---- default fluid properties from QDEF.INC
      RHO = RHO1   ! density
      RMU = RMU1   ! viscosity
      VSO = VSO1   ! speed of sound
C
      CALL QCGET(RHO,RMU,VSO)
C
C==========================================================
C---- set default prop
      PNAME = &#39;Graupner CAM 6x3 folder&#39;
      BLDS = 2.0
C
C---- number of radial stations
      NR = 7
C
C---- linear CL(alpha) function
C     CL  =  CL0 + DCLCD*alpha  ,  clipped if outside range  CLMIN..CLMAX
      DO IR = 1, NR
        CL0B(IR) = 0.5
        DCLDAB(IR) = 5.8
        CLMINB(IR) = -0.4
        CLMAXB(IR) = 1.2
      ENDDO
C
C---- quadratic CD(CL,Re) function
C     CD  =  [ CD0 + CD2*(CL-CLCD0)**2 ] * [Re/REREF]^REEXP
      DO IR = 1, NR
        CD0B(IR) = 0.028
        CD2UB(IR) = 0.050
        CD2LB(IR) = 0.050
        CLCD0B(IR) = 0.5
        REREFB(IR) = 70000.0
        REEXPB(IR) = -0.7
        MCRITB(IR) = MCRIT0
      ENDDO
C
C---- radii
      RFAC = 0.0254
      RADD = 0.
      RB(1) = 0.75  
      RB(2) = 1.00  
      RB(3) = 1.50  
      RB(4) = 2.00  
      RB(5) = 2.50  
      RB(6) = 2.875 
      RB(7) = 3.00  
C
C---- chords
      CFAC = 0.0254
      CADD = 0.
      CB(1) = 0.66 
      CB(2) = 0.69 
      CB(3) = 0.63 
      CB(4) = 0.55 
      CB(5) = 0.44 
      CB(6) = 0.30 
      CB(7) = 0.19 
C
C---- blade angles
      BFAC = 1.0
      BADD = 0.
      BB(1) = 27.5
      BB(2) = 22.0
      BB(3) = 15.2
      BB(4) = 10.2
      BB(5) =  6.5
      BB(6) =  4.6
      BB(7) =  4.2
C
      RAD = RB(NR)
C
C----------------------------------------------------
C---- default motor/gear combo
      MNAME = &quot;Speed-400 3321 (6V) direct drive&quot;
      IMOTYPE = 1
      PARMOT(1) = 0.31    ! Rmotor  (Ohms)
      PARMOT(2) = 0.77    ! Io      (Amps)
      PARMOT(3) = 2760.0  ! Kv      (rpm/Volt)
      PMLAB(1) = &#39;R  (Ohm)&#39;
      PMLAB(2) = &#39;Io (Amp)&#39;
      PMLAB(3) = &#39;Kv (rpm/Volt)&#39;
      NMPAR = 3
C
C----------------------------------------------------
C---- default parameter sweeps
      VEL1 =  0.0
      VEL2 = 10.0
      NVEL = 6
C
      RPM1 = 10000.0
      RPM2 = 16000.0
      NRPM = 7
C
      VOLT1 = 6.0
      VOLT2 = 9.0
      NVOLT = 4
C
      DBET1 = -2.0
      DBET2 =  2.0
      NDBET = 5
C
      THRU1 = 0.
      THRU2 = 0.
      NTHRU = 1
C
      AMPS1 = 0.
      AMPS2 = 0.
      NAMPS = 1
C
      PELE1 = 0.
      PELE2 = 0.
      NPELE = 1
C
C---- do not dump radial distributions
      LRDUMP = .FALSE.
C
C==========================================================
 1000 FORMAT(A)
C
C----------------------------------------------------
C---- read prop data file
      FILNAM = ARGP1
      IF(FILNAM.EQ.&#39; &#39;) GO TO 18
C
      LU = 1
      OPEN(LU,FILE=FILNAM,STATUS=&#39;OLD&#39;,ERR=18)
C
      ILINE = 0
C
C---- prop name
      CALL FREAD(LU,LINE,ILINE,IERR,PNAME)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
C
C---- extract parameters on data lines
      NVAL = 2
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 1) GO TO 980
      BLDS = RVAL(1)
      IF(NVAL.GE.2) THEN
       RAD = RVAL(2)
      ELSE
       RAD = 0.
      ENDIF
C
      NVAL = 2
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 2) GO TO 980
      DO IR = 1, IRDIM
        CL0B(IR)   = RVAL(1)
        DCLDAB(IR) = RVAL(2)
      ENDDO
C
      NVAL = 2
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 2) GO TO 980
      DO IR = 1, IRDIM
        CLMINB(IR) = RVAL(1)
        CLMAXB(IR) = RVAL(2)
      ENDDO
C
      NVAL = 4
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      DO IR = 1, IRDIM
        CD0B(IR)   = RVAL(1)
        CD2UB(IR)  = RVAL(2)
        CD2LB(IR)  = RVAL(3)
        CLCD0B(IR) = RVAL(4)
      ENDDO
C
      NVAL = 2
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 2) GO TO 980
      DO IR = 1, IRDIM
        REREFB(IR) = RVAL(1)
        REEXPB(IR) = RVAL(2)
      ENDDO
C
C
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      RFAC = RVAL(1)
      CFAC = RVAL(2)
      BFAC = RVAL(3)
C
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      RADD = RVAL(1)
      CADD = RVAL(2)
      BADD = RVAL(3)
C
      KR = 0
C
 14   CONTINUE
C
        NVAL = 13
        CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
        IF(IERR.EQ.+1) GO TO 900
        IF(IERR.EQ.-1) GO TO 16
        IF(NVAL.LT. 3) GO TO 980
C
        KR = KR + 1
        IR = MIN( KR , IRDIM )
        RB(IR) = RVAL(1)
        CB(IR) = RVAL(2)
        BB(IR) = RVAL(3)
C
        MCRITB(IR) = MCRIT0
C
        IF(NVAL.GE. 4) CL0B(IR)   = RVAL( 4)
        IF(NVAL.GE. 5) DCLDAB(IR) = RVAL( 5)
        IF(NVAL.GE. 6) CLMINB(IR) = RVAL( 6)
        IF(NVAL.GE. 7) CLMAXB(IR) = RVAL( 7)
        IF(NVAL.GE. 8) CD0B(IR)   = RVAL( 8)
        IF(NVAL.GE. 9) CD2UB(IR)  = RVAL( 9)
        IF(NVAL.GE.10) CD2LB(IR)  = RVAL(10)
        IF(NVAL.GE.11) CLCD0B(IR) = RVAL(11)
        IF(NVAL.GE.12) REREFB(IR) = RVAL(12)
        IF(NVAL.GE.13) REEXPB(IR) = RVAL(13)
C
        GO TO 14
C
 16   CONTINUE
      CLOSE(LU)
C
      IF(KR.GT.0) THEN
       NR = IR
       IF(KR.GT.NR) THEN
        WRITE(*,*) &#39;Array overflow.  Increase IRDIM to&#39;, KR
        STOP
       ENDIF
      ENDIF
      GO TO 19
C
 18   CONTINUE
      WRITE(*,*)
      WRITE(*,*) &#39;Prop file not found:  &#39;, FILNAM(1:48)
      WRITE(*,*) &#39;Default prop used  :  &#39;, PNAME
C
C
 19   CONTINUE
C
      IF(NR.LE.1) THEN
       WRITE(*,*)
       WRITE(*,*) &#39;*** Must define at least two radial stations&#39;
       STOP
      ENDIF
C
C---- apply scaling factors
      DO IR = 1, NR
        RB(IR) =  RB(IR)*RFAC + RADD
        CB(IR) =  CB(IR)*CFAC + CADD
        BB(IR) = (BB(IR)*BFAC + BADD)* PI / 180.0
      ENDDO
C
      IF(RAD .EQ. 0.0) THEN
       RAD = RB(NR)
      ENDIF
C
      DO IR = 1, NR-1
        IF(CB(IR) .LE. 0.0) 
     &amp;     STOP &#39;Chords must be positive&#39;
        IF(RB(IR) .LT. 0.0)
     &amp;     STOP &#39;Radii must be nonnegative&#39;
        IF(RB(IR) .GE. RB(IR+1))
     &amp;     STOP &#39;Radii must increase monotonically&#39;
      ENDDO
C
      IF(RAD .LT. RB(NR)) THEN
       WRITE(*,1050) RAD, RB(NR)
 1050  FORMAT(/&#39; Given on line 2:  R =&#39;, G12.4,
     &amp;        /&#39; Last r station :  r =&#39;, G12.4,
     &amp;       //&#39; Must have  R &gt; r&#39; / )
       STOP
      ENDIF
C
C==========================================================
C---- read motor data file
      FILNAM = ARGP2
      IF(FILNAM.EQ.&#39; &#39;) GO TO 28
C
      LU = 2
      OPEN(LU,FILE=FILNAM,STATUS=&#39;OLD&#39;,ERR=28)
C
C---- clear motor data in case it&#39;s not all in the file
      DO IMPAR = 1, NMPDIM
        PARMOT(IMPAR) = 0.0
        PMLAB(IMPAR) = &#39; &#39;
      ENDDO
C
      ILINE = 0
C
C---- motor name
      CALL FREAD(LU,LINE,ILINE,IERR,MNAME)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
C
C---- motor model index
      NVAL = 1
      CALL IREAD(LU,LINE,ILINE,IERR,NVAL,IVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 1) GO TO 980
      IMOTYPE = IVAL(1)
C
C---- extract parameters on data lines
      DO IMPAR = 1, NMPDIM+1
        NVAL = 1
        CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
        IF(IERR.EQ.+1) GO TO 900
        IF(IERR.EQ.-1) GO TO 25
        IF(NVAL.LT. 1) GO TO 980
        IF(IMPAR.EQ.NMPDIM+1) THEN
         WRITE(*,*) &#39;* Motor parameter array overflow. Increase NMPDIM&#39;
         STOP
        ENDIF
        PARMOT(IMPAR) = RVAL(1)
        KEX = INDEX(LINE,&#39;!&#39;)
        IF(KEX.GE.1) THEN
         PMLAB(IMPAR) = LINE(KEX+1:80)
        ELSE
         PMLAB(IMPAR) = &#39; &#39;
        ENDIF
      ENDDO
C
 25   CONTINUE
      NMPAR = IMPAR-1
C
      CLOSE(LU)
      GO TO 29
C
 28   CONTINUE
      WRITE(*,*)
      WRITE(*,*) &#39;Motor file not found:  &#39;, FILNAM(1:48)
      WRITE(*,*) &#39;Default motor used  :  &#39;, MNAME
C
 29   CONTINUE
C
C==========================================================
C---- operating parameter data file, or single-point parameters
      FILNAM = ARGP3
      IF(FILNAM.EQ.&#39; &#39;) GO TO 80
C
C---- first assume that 3rd Unix argument is parameter data filename
      LU = 4
      OPEN(LU,FILE=FILNAM,STATUS=&#39;OLD&#39;,ERR=31)
C
C---- file open successful... read parameter data
      ILINE = 0
C
C---- extract parameters on data lines
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      VEL1 = RVAL(1)
      VEL2 = RVAL(2)
      NVEL = INT( RVAL(3) + 0.01 )
C
C---- extract parameters on data lines
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      RPM1 = RVAL(1)
      RPM2 = RVAL(2)
      NRPM = INT( RVAL(3) + 0.01 )
C
C---- extract parameters on data lines
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1) GO TO 950
      IF(NVAL.LT. 3) GO TO 980
      VOLT1 = RVAL(1)
      VOLT2 = RVAL(2)
      NVOLT = INT( RVAL(3) + 0.01 )
C
C---- extract parameters on data lines
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1 .OR. NVAL.LT. 3) THEN
       DBET1 = 0.0
       DBET2 = 0.0
       NDBET = 0
      ELSE
       DBET1 = RVAL(1)
       DBET2 = RVAL(2)
       NDBET = INT( RVAL(3) + 0.01 )
      ENDIF
      NDBET = MAX( 1 , NDBET )
C
      NVAL = 3
      CALL RREAD(LU,LINE,ILINE,IERR,NVAL,RVAL)
      IF(IERR.EQ.+1) GO TO 900
      IF(IERR.EQ.-1 .OR. NVAL.LT. 3) THEN
       THRU1 = 0.0
       THRU2 = 0.0
       NTHRU = 0
      ELSE
       THRU1 = RVAL(1)
       THRU2 = RVAL(2)
       NTHRU = INT( RVAL(3) + 0.01 )
      ENDIF
      NTHRU = MAX( 1 , NTHRU )
C
      CLOSE(LU)
      GO TO 82
C
C-------------------------------------------------------
C---- pick up here if 3rd Unix argument is not a filename
 31   CONTINUE
C
C---- try reading velocity 3rd Unix argument
      CALL PPARSE(ARGP3,VEL1,VEL2,NVEL,IERR)
      IF(IERR.EQ.+1) GO TO 80
      IF(IERR.EQ.-1) GO TO 80
C
C---- set new default single-point RPM or VOLT
      RPM1 = 0.
      RPM2 = 0.
      NRPM = 0
C
      VOLT1 = 0.
      VOLT2 = 0.
      NVOLT = 0
C
      DBET1 = 0.
      DBET2 = 0.
      NDBET = 1
C
      THRU1 = 0.
      THRU2 = 0.
      NTHRU = 1
C
      TORQ1 = 0.
      TORQ2 = 0.
      NTORQ = 1
C
      AMPS1 = 0.
      AMPS2 = 0.
      NAMPS = 1
C
      PELE1 = 0.
      PELE2 = 0.
      NPELE = 1
C
C---- try reading Rpm from 4th Unix argument
      CALL PPARSE(ARGP4,RPM1,RPM2,NRPM,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       RPM = 0.0
       NRPM = 0
      ENDIF
C
C---- try reading Voltage from 5th Unix argument
      CALL PPARSE(ARGP5,VOLT1,VOLT2,NVOLT,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       VOLT = 0.0
       NVOLT = 0
      ENDIF
C
C---- try reading pitch change from 6th Unix argument
      CALL PPARSE(ARGP6,DBET1,DBET2,NDBET,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       DBET = 0.0
       NDBET = 1
      ENDIF
C
C---- try reading thrust from 7th Unix argument
      CALL PPARSE(ARGP7,THRU1,THRU2,NTHRU,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       THRU = 0.0
       NTHRU = 1
      ENDIF
C
C---- try reading torque from 8th Unix argument
      CALL PPARSE(ARGP8,TORQ1,TORQ2,NTORQ,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       TORQ = 0.0
       NTHRU = 1
      ENDIF
C
C---- try reading current from 9th Unix argument
      CALL PPARSE(ARGP9,AMPS1,AMPS2,NAMPS,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       AMPS = 0.0
       NAMPS = 1
      ENDIF
C
C---- try reading Pele from 10th Unix argument
      CALL PPARSE(ARGP10,PELE1,PELE2,NPELE,IERR)
      IF(IERR.EQ.+1 .OR.
     &amp;   IERR.EQ.-1     ) THEN
       PELE = 0.0
       NPELE = 1
      ENDIF
C
C---- if this is a single-point case... will dump radial distributions
      LRDUMP = NVEL .LE.1
     &amp;   .AND. NRPM .LE.1
     &amp;   .AND. NVOLT.LE.1
     &amp;   .AND. NDBET.LE.1
     &amp;   .AND. NTHRU.LE.1
     &amp;   .AND. NTORQ.LE.1
     &amp;   .AND. NAMPS.LE.1
     &amp;   .AND. NPELE.LE.1
C
      GO TO 82
C
C
 80   CONTINUE
      WRITE(*,*)
      WRITE(*,*) &#39;Run parameter file not found: &#39;, FILNAM(1:48)
      WRITE(*,*) &#39;Default velocities, voltages, pitch used&#39;
C
 82   CONTINUE
C
      IF(NRPM .EQ.0 .AND. 
     &amp;   NVOLT.EQ.0 .AND. 
     &amp;   NTHRU.EQ.0 .AND.
     &amp;   NAMPS.EQ.0 .AND.
     &amp;   NPELE.EQ.0       ) THEN
       WRITE(*,*) 
     &amp;  &#39;Must specify either Rpm or Volts or Thrust or Amps or Pele&#39;
       STOP
      ENDIF
C
      LRPMSET  = NRPM  .GT. 0 .AND. (RPM1  .NE. 0.0 .OR. RPM2  .NE. 0.0)
      LVOLTSET = NVOLT .GT. 0 .AND. (VOLT1 .NE. 0.0 .OR. VOLT2 .NE. 0.0)
      LTHRUSET = NTHRU .GT. 0 .AND. (THRU1 .NE. 0.0 .OR. THRU2 .NE. 0.0)
      LTORQSET = NTORQ .GT. 0 .AND. (TORQ1 .NE. 0.0 .OR. TORQ2 .NE. 0.0)
      LAMPSSET = NAMPS .GT. 0 .AND. (AMPS1 .NE. 0.0 .OR. AMPS2 .NE. 0.0)
      LPELESET = NPELE .GT. 0 .AND. (PELE1 .NE. 0.0 .OR. PELE2 .NE. 0.0)
C
cc    write(*,*)
cc   &amp;  lrpmset, lvoltset, lthruset, ltorqset, lampsset, lpeleset

C==========================================================
C
C---- set up finely-spaced radial arrays
      R0 = RB(1)
      R1 = RB(NR)
C
      N = IDIM
      DO I = 1, N
        FRAC = (FLOAT(I)-0.5)/FLOAT(N)
        R(I) = R0*(1.0-FRAC) + R1*FRAC
        DR(I) = (R1-R0)/FLOAT(N)
      ENDDO
C
      CALL SPLINE(CB,WORK,RB,NR)
      DO I = 1, N
        C(I) = SEVAL(R(I),CB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(BB,WORK,RB,NR)
      DO I = 1, N
        B(I) = SEVAL(R(I),BB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CL0B,WORK,RB,NR)
      DO I = 1, N
        CL0(I) = SEVAL(R(I),CL0B,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(DCLDAB,WORK,RB,NR)
      DO I = 1, N
        DCLDA(I) = SEVAL(R(I),DCLDAB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CLMINB,WORK,RB,NR)
      DO I = 1, N
        CLMIN(I) = SEVAL(R(I),CLMINB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CLMAXB,WORK,RB,NR)
      DO I = 1, N
        CLMAX(I) = SEVAL(R(I),CLMAXB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CD0B,WORK,RB,NR)
      DO I = 1, N
        CD0(I) = SEVAL(R(I),CD0B,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CD2UB,WORK,RB,NR)
      DO I = 1, N 
        CD2U(I) = SEVAL(R(I),CD2UB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CD2LB,WORK,RB,NR)
      DO I = 1, N
        CD2L(I) = SEVAL(R(I),CD2LB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(CLCD0B,WORK,RB,NR)
      DO I = 1, N
        CLCD0(I) = SEVAL(R(I),CLCD0B,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(REREFB,WORK,RB,NR)
      DO I = 1, N
        REREF(I) = SEVAL(R(I),REREFB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(REEXPB,WORK,RB,NR)
      DO I = 1, N
        REEXP(I) = SEVAL(R(I),REEXPB,WORK,RB,NR)
      ENDDO
C
      CALL SPLINE(MCRITB,WORK,RB,NR)
      DO I = 1, N
        MCRIT(I) = SEVAL(R(I),MCRITB,WORK,RB,NR)
      ENDDO
C
C---- reality checks
      ERROR = .FALSE.
      DO I = 1, N
        IF(C(I) .LE. 0.0) THEN
         WRITE(*,*) &#39;Negative chord at i =&#39;, I
         ERROR = .TRUE.
        ENDIF
        IF(REREF(I) .LE. 0.0) THEN
         WRITE(*,*) &#39;Negative Re_ref at i =&#39;, I
         ERROR = .TRUE.
        ENDIF
        IF(MCRIT(I) .LE. 0.0) THEN
         WRITE(*,*) &#39;Negative Mcrit at i =&#39;, I
         ERROR = .TRUE.
        ENDIF
      ENDDO
C
      IF(ERROR) THEN
        WRITE(*,*)
       WRITE(*,1100)
     &amp; &#39; i   radius   chord     beta    Re_ref&#39;
        DO I = 1, N
          IRE = INT( REREF(I) )
          WRITE(*,1070) I, R(I), C(I), B(I)*180.0/PI, IRE
 1070     FORMAT(1X,I3, F9.4, F9.4, F9.3, I9)
        ENDDO
        WRITE(*,*)
        STOP
      ENDIF

C
C----------------------------------------------------
C---- perform calculations and dump output
C
      LU = 6
      WRITE(*,*)
C
 1105 FORMAT(&#39;# QPROP Version&#39;, F5.2)
 1100 FORMAT(&#39;# &#39;, A,A,A,A)
 1110 FORMAT(&#39;#  &#39;, G12.5, 1X, A)
 1120 FORMAT(&#39;#   rho =&#39;, G12.5,&#39; kg/m^3&#39;
     &amp;      /&#39;#   mu  =&#39;, G12.5,&#39; kg/m-s&#39;
     &amp;      /&#39;#   a   =&#39;, G12.5,&#39; m/s   &#39; )
C
      WRITE(LU,1105) VERSION
      WRITE(LU,1100)
      WRITE(LU,1100) PNAME
      WRITE(LU,1100)
      WRITE(LU,1100) MNAME
      DO IMPAR=1, NMPAR
        WRITE(LU,1110) PARMOT(IMPAR), PMLAB(IMPAR)
      ENDDO
      WRITE(LU,1100)
      WRITE(LU,1120) RHO, RMU, VSO
      WRITE(LU,1100)
      WRITE(LU,1100)
     &amp; &#39; 1         2        3          4          5        &#39;,
     &amp; &#39; 6            7         8       9        10        11    &#39;,
     &amp; &#39;    12          13        14        15      16          17   &#39;,
     &amp; &#39;        18      19&#39;
      WRITE(LU,1100)
      WRITE(LU,1100)
     &amp; &#39; V(m/s)    rpm      Dbeta      T(N)       Q(N-m)   &#39;,
     &amp; &#39; Pshaft(W)    Volts     Amps    effmot   effprop   adv   &#39;,
     &amp; &#39;    CT          CP        DV(m/s)   eff     Pelec       Pprop&#39;,
     &amp; &#39;        cl_avg  cd_avg&#39;
C
      IF(LRDUMP) THEN
       CHARF = &#39;#&#39;
      ELSE
       CHARF = &#39; &#39;
      ENDIF
C
      NVELM = MAX( 1 , NVEL-1 )
      DVEL = (VEL2-VEL1)/FLOAT(NVELM)
C
      NDBETM = MAX( 1 , NDBET-1 )
      DDBET = (DBET2-DBET1)/FLOAT(NDBETM)
C
      IF(LRPMSET) THEN
       NRPMM = MAX( 1 , NRPM-1 )
       PAR1 = RPM1
       PAR2 = RPM2
       DPAR = (RPM2-RPM1)/FLOAT(NRPMM)
       NPAR = NRPM
      ELSEIF(LVOLTSET) THEN
       NVOLTM = MAX( 1 , NVOLT-1 )
       PAR1 = VOLT1
       PAR2 = VOLT2
       DPAR = (VOLT2-VOLT1)/FLOAT(NVOLTM)
       NPAR = NVOLT
      ELSEIF(LTHRUSET) THEN
       NTHRUM = MAX( 1 , NTHRU-1 )
       PAR1 = THRU1
       PAR2 = THRU2
       DPAR = (THRU2-THRU1)/FLOAT(NTHRUM)
       NPAR = NTHRU
      ELSEIF(LTORQSET) THEN
       NTORQM = MAX( 1 , NTORQ-1 )
       PAR1 = TORQ1
       PAR2 = TORQ2
       DPAR = (TORQ2-TORQ1)/FLOAT(NTORQM)
       NPAR = NTORQ
      ELSEIF(LAMPSSET) THEN
       NAMPSM = MAX( 1 , NAMPS-1 )
       PAR1 = AMPS1
       PAR2 = AMPS2
       DPAR = (AMPS2-AMPS1)/FLOAT(NAMPSM)
       NPAR = NAMPS
      ELSEIF(LPELESET) THEN
       NPELEM = MAX( 1 , NPELE-1 )
       PAR1 = PELE1
       PAR2 = PELE2
       DPAR = (PELE2-PELE1)/FLOAT(NPELEM)
       NPAR = NPELE
      ELSE
       WRITE(*,*) &#39;Additional parameter not specified&#39;
       WRITE(*,*) &#39; RPM   :&#39;,  lrpmset
       WRITE(*,*) &#39; Volt  :&#39;,  lvoltset
       WRITE(*,*) &#39; Thrust:&#39;,  lthruset
       WRITE(*,*) &#39; Torque:&#39;,  ltorqset
       WRITE(*,*) &#39; Amps  :&#39;,  lampsset
       WRITE(*,*) &#39; Pelec :&#39;,  lpeleset
       STOP
      ENDIF
C
      LRDUMP = NVEL .LE.1
     &amp;   .AND. NRPM .LE.1
     &amp;   .AND. NVOLT.LE.1
     &amp;   .AND. NDBET.LE.1
     &amp;   .AND. NTHRU.LE.1
     &amp;   .AND. NTORQ.LE.1
     &amp;   .AND. NAMPS.LE.1
     &amp;   .AND. NPELE.LE.1

C
      DO IDBET = 1, NDBET
        DBET = DBET1 + DDBET*FLOAT(IDBET-1)
        DBE = DBET * PI/180.0
C
        DO IPAR = 1, NPAR
          PAR = PAR1 + DPAR*FLOAT(IPAR-1)
C
          IF    (LRPMSET ) THEN
           RPM = PAR
          ELSEIF(LVOLTSET) THEN
           VOLT = PAR
          ELSEIF(LTHRUSET) THEN
           THRU = PAR
          ELSEIF(LTORQSET) THEN
           TORQ = PAR
          ELSEIF(LAMPSSET ) THEN
           AMPS = PAR
          ELSEIF(LPELESET) THEN
           PELE = PAR
          ENDIF
C
          DO IVEL = 1, NVEL
            VEL = VEL1 + DVEL*FLOAT(IVEL-1)
C
C---------- set initial omega
            IF    (LRPMSET) THEN
             OMG = RPM * PI/30.0
C
            ELSEIF(LVOLTSET) THEN
C----------- guess using 80% radius effective pitch angle
             I = MAX( 1 , (8*N)/10 )
             RT = R(I)
             BT = B(I) - CL0(I)/DCLDA(I) + DBE
             BT = MAX( 0.02 , MIN( 0.45*PI , BT ) )
             IF(VEL.EQ.0.0) THEN
              OMG = 1.0
             ELSE
              OMG = VEL/(RT*TAN(BT))
             ENDIF
C
            ELSE
C----------- guess using 80% radius effective pitch angle
             I = MAX( 1 , (8*N)/10 )
             RT = R(I)
             BT = B(I) - CL0(I)/DCLDA(I) + DBE
             BT = MAX( 0.02 , MIN( 0.45*PI , BT ) )
             IF(VEL.EQ.0.0) THEN
              OMG = 1.0
             ELSE
              OMG = VEL/(RT*TAN(BT))
             ENDIF
C
C----------- set voltage to get zero torque
             QP = 0.
             CALL VOLTM(OMG,QP, IMOTYPE, PARMOT,NMPAR,
     &amp;                  VM,VM_OMG,VM_QP,
     &amp;                  AM,AM_OMG,AM_QP )
             VOLT = VM
            ENDIF
C
C---------- Newton iteration to converge on trimmed omega
            DO 100 ITER = 1, 25
              CALL TQCALC(N,C,B,R,DR,
     &amp;              VA,VT,CL,CD,STALL,
     &amp;              BLDS,RAD,VEL,OMG,DBE,
     &amp;              RHO,RMU,VSO,
     &amp;              CL0,DCLDA,CLMIN,CLMAX,MCRIT,
     &amp;              CD0,CD2U,CD2L,CLCD0,REREF,REEXP,
     &amp;              TP, TP_VEL, TP_OMG, TP_DBE, TP_C, TP_B,
     &amp;              QP, QP_VEL, QP_OMG, QP_DBE, QP_C, QP_B )
C
              IF(LRPMSET) THEN
C------------- Residual  =  prop omega  -  prescribed omega
               RES = 0.
               RES_OMG = 1.0
C
C------------- Newton change
               DOMG = -RES/RES_OMG
               DVOLT = 0.
C
C------------- set voltage = f(w,Q) by inverting MOTORQ&#39;s Q(w,voltage) function
               CALL VOLTM(OMG,QP, IMOTYPE, PARMOT,NMPAR,
     &amp;                  VM,VM_OMG,VM_QP,
     &amp;                  AM,AM_OMG,AM_QP )
               VOLT = VM
               AMPS = AM
C
              ELSEIF(LVOLTSET) THEN
               CALL MOTORQ(OMG,VOLT, IMOTYPE, PARMOT,NMPAR, 
     &amp;                     QM,QM_OMG,QM_VOLT,
     &amp;                     AM,AM_OMG,AM_VOLT )
C
C------------- Residual  =  prop torque - motor torque  at current omega
               RES     = QP     - QM
               RES_OMG = QP_OMG - QM_OMG
C
C------------- Newton change
               DOMG = -RES/RES_OMG
               DVOLT = 0.
C
               AMPS = AM
C
              ELSEIF(LTHRUSET) THEN
               CALL MOTORQ(OMG,VOLT, IMOTYPE, PARMOT,NMPAR, 
     &amp;                     QM,QM_OMG,QM_VOLT,
     &amp;                     AM,AM_OMG,AM_VOLT )
C
C------------- Residual  =  prop torque - motor torque  at current omega
               RES1      = QP     - QM
               RES1_OMG  = QP_OMG - QM_OMG
               RES1_VOLT =        - QM_VOLT
C
C------------- Residual  =  prop thrust - specified thrust
               RES2      = TP     - THRU
               RES2_OMG  = TP_OMG
               RES2_VOLT = 0.
C
               A11 = RES1_OMG
               A12 = RES1_VOLT
               A21 = RES2_OMG
               A22 = RES2_VOLT
C
               DET   =   A11 *A22  - A12 *A21
               DOMG  = -(RES1*A22  - A12 *RES2) / DET
               DVOLT = -(A11 *RES2 - RES1*A21 ) / DET
C
               AMPS = AM
C
              ELSEIF(LTORQSET) THEN
               CALL MOTORQ(OMG,VOLT, IMOTYPE, PARMOT,NMPAR, 
     &amp;                     QM,QM_OMG,QM_VOLT,
     &amp;                     AM,AM_OMG,AM_VOLT )
C
C------------- Residual  =  prop torque - motor torque  at current omega
               RES1      = QP     - QM
               RES1_OMG  = QP_OMG - QM_OMG
               RES1_VOLT =        - QM_VOLT
C
C------------- Residual  =  prop torque - specified torque
               RES2      = QP     - TORQ
               RES2_OMG  = QP_OMG
               RES2_VOLT = 0.
C
               A11 = RES1_OMG
               A12 = RES1_VOLT
               A21 = RES2_OMG
               A22 = RES2_VOLT
C
               DET   =   A11 *A22  - A12 *A21
               DOMG  = -(RES1*A22  - A12 *RES2) / DET
               DVOLT = -(A11 *RES2 - RES1*A21 ) / DET
C
               AMPS = AM
C
              ELSEIF(LAMPSSET) THEN
               CALL MOTORQ(OMG,VOLT, IMOTYPE, PARMOT,NMPAR, 
     &amp;                     QM,QM_OMG,QM_VOLT, 
     &amp;                     AM,AM_OMG,AM_VOLT )
C
C------------- Residual  =  prop torque - motor torque  at current omega
               RES1      = QP     - QM
               RES1_OMG  = QP_OMG - QM_OMG
               RES1_VOLT =        - QM_VOLT
C
C------------- Residual  = amps - specified amps
               RES2      = AM   - AMPS
               RES2_OMG  = AM_OMG
               RES2_VOLT = AM_VOLT
C
               A11 = RES1_OMG
               A12 = RES1_VOLT
               A21 = RES2_OMG
               A22 = RES2_VOLT
C
               DET   =   A11 *A22  - A12 *A21
               DOMG  = -(RES1*A22  - A12 *RES2) / DET
               DVOLT = -(A11 *RES2 - RES1*A21 ) / DET
C
              ELSEIF(LPELESET) THEN
               CALL MOTORQ(OMG,VOLT, IMOTYPE, PARMOT,NMPAR, 
     &amp;                     QM,QM_OMG,QM_VOLT, 
     &amp;                     AM,AM_OMG,AM_VOLT )
C
C------------- Residual  =  prop torque - motor torque  at current omega
               RES1      = QP     - QM
               RES1_OMG  = QP_OMG - QM_OMG
               RES1_VOLT =        - QM_VOLT
C
C------------- Residual  =  Pele - specified Pele
               RES2      = VOLT*AM   - PELE
               RES2_OMG  = VOLT*AM_OMG
               RES2_VOLT = VOLT*AM_VOLT + AM
C
               A11 = RES1_OMG
               A12 = RES1_VOLT
               A21 = RES2_OMG
               A22 = RES2_VOLT
C
               DET   =   A11 *A22  - A12 *A21
               DOMG  = -(RES1*A22  - A12 *RES2) / DET
               DVOLT = -(A11 *RES2 - RES1*A21 ) / DET
C
               AMPS = AM
C
              ENDIF
C
              RLX = 1.0
              IF(RLX*DOMG  .GT.  1.0*OMG) RLX =  1.0*OMG/DOMG
              IF(RLX*DOMG  .LT. -0.5*OMG) RLX = -0.5*OMG/DOMG
C
              IF(RLX*DVOLT .GT.  2.0*VOLT) RLX =  2.0*VOLT/DVOLT
              IF(RLX*DVOLT .LT. -0.5*VOLT) RLX = -0.5*VOLT/DVOLT

c           write(*,&#39;(1x,i3,2(f12.3,e12.4),f7.3)&#39;) 
c    &amp;            iter, omg, domg, volt, dvolt, rlx

C------------ convergence check
              IF(ABS(DOMG) .LT. EPS*ABS(OMG)) GO TO 110
C
C------------ Newton update
              OMG  = OMG  + RLX*DOMG
              VOLT = VOLT + RLX*DVOLT
 100        CONTINUE
cc            WRITE(*,*) &#39;QPROP: Convergence failed. Res =&#39;, RES
C
 110        CONTINUE

c        Q = 1.0 / (Kv*pi/30.0) * (I-Io)
c        I = Io + Q*(Kv*pi/30.0)
c        P = (V-I*R) * (I-Io)
c        eff = P / (I*V)
c        rpm = Kv * (V-I*R)
C
C---------- compute thrust-average blade cl and cd
            DTSUM = 0.
            CLAVG = 0.
            CDAVG = 0.
            DO I = 1, N
              WA = VEL + VA(I)
              WT = OMG*R(I) - VT(I)
              WSQ = WA**2 + WT**2
              DTSUM = DTSUM + WSQ*C(I)*DR(I)
              CLAVG = CLAVG + WSQ*C(I)*DR(I)*CL(I)
              CDAVG = CDAVG + WSQ*C(I)*DR(I)*CD(I)
            ENDDO
            CLAVG = CLAVG / DTSUM
            CDAVG = CDAVG / DTSUM
C
C---------- print output
            RPM = OMG*30.0/PI
            PPROP = TP*VEL
            POWER = QP*OMG
C
            PINPUT = VOLT*AMPS
C
            IF(POWER .NE. 0.0) THEN
             EFFP = PPROP/POWER
            ELSE
             EFFP = 0.
            ENDIF
C
            IF(PINPUT .NE. 0.0) THEN
             EFFM = POWER/PINPUT
            ELSE
             EFFM = 0.0
            ENDIF
C
            EFF = EFFM*EFFP
C
            IF(ABS(OMG).GT.0.0) THEN
             ADV = VEL/(OMG*RAD)
            ELSE
             ADV = 0.
            ENDIF
C
            IF(OMG .EQ. 0.0) THEN
             WRI = 0.
            ELSE
             WRI = 1.0 / (OMG*RAD)
            ENDIF
C
            CT = TP * WRI**2 * 2.0 / (RHO * PI * RAD**2)
            CP = QP * WRI**2 * 2.0 / (RHO * PI * RAD**3)
            DV = SQRT(VEL**2 + TP * 2.0/(RHO*PI*RAD**2)) - VEL
C
            WRITE(LU,2100) CHARF,
     &amp;        VEL,   RPM,  DBET,   TP,     QP, POWER, 
     &amp;       VOLT,AMPS,  EFFM,  EFFP, ADV, CT, CP, DV, 
     &amp;       EFF, PINPUT, PPROP, CLAVG, CDAVG
 2100       FORMAT(A,
     &amp;       F8.3,  G12.4,  F7.3, G12.4, G12.4, G12.4,
     &amp;       F8.3, F10.4,  F9.4, F9.4, F10.5, G12.4, G12.4, F9.4,
     &amp;       F9.4, G12.4, G12.4, F9.4, G12.4)
          ENDDO
          IF(.NOT.LRDUMP .AND. NVEL.GT.1) WRITE(LU,1000)
        ENDDO
      ENDDO
C
      IF(LRDUMP) THEN
C----- dump radial distributions
       WRITE(LU,1100)
       WRITE(LU,1100)
     &amp; &#39; radius   chord   beta      Cl       Cd       Re    Mach&#39;,
     &amp; &#39;     effi     effp    Wa(m/s)     Aswirl      adv_wake&#39;
C                              123456789012123456789012123456789012
       DO I = 1, N
         WA = VEL + VA(I)
         WT = OMG*R(I) - VT(I)
         WSQ = WA**2 + WT**2
         W = SQRT(WSQ)
C
C------- local Mach and Re
         AMA = W/VSO
         IRE = INT( RHO*W*C(I)/RMU + 0.5 )
C
C------- local wake advance ratio, induced and profile efficiencies
         IF(WA.NE.0.0 .AND. WT.NE.0.0) THEN
          ADW = (WA/WT) * (R(I)/RAD)
          EFFI = (VEL/(OMG*R(I))) * (WT/WA)
          EFFP = (CL(I) - CD(I)*WA/WT)
     &amp;         / (CL(I) + CD(I)*WT/WA)
         ELSE
          ADW = 0.
          EFFI = 0.
          EFFP = 0.
         ENDIF
C
         EFFI = MAX( -99.0 , MIN( 99.0 , EFFI ) )
         EFFP = MAX( -99.0 , MIN( 99.0 , EFFP ) )
C
         RU = R(I)
         CU = C(I)
         BU = B(I) * 180.0/PI
C
C------- swirl flow angle in non-rotating frame
         ASWIRL = ATAN2( VT(I) , WA ) * 180.0/PI
C
         WRITE(LU,3100) 
     &amp;               RU,   CU,   BU, CL(I), CD(I),
     &amp;              IRE,  AMA, EFFI, EFFP, WA, ASWIRL, ADW
 3100    FORMAT(1X,F8.4, F8.4, F8.3, F9.4,  F9.5,
     &amp;               I9, F7.3, F9.4, F9.4, G12.4, G12.4, G12.4)
       ENDDO
      ENDIF
C
      STOP
C
 900  CONTINUE
      WRITE(*,9000) FILNAM(1:64), ILINE, LINE
 9000 FORMAT(/&#39; Read error&#39;
     &amp;       /&#39;   in file:  &#39;, A
     &amp;       /&#39;   line&#39;,I3,&#39;:  &#39;, A)
      STOP
C
 950  CONTINUE
      WRITE(*,9500) FILNAM(1:64), ILINE
 9500 FORMAT(/&#39; Unexpected end-of-file reached&#39;
     &amp;       /&#39;   in file:  &#39;, A
     &amp;       /&#39;   line&#39;,I3)
      STOP
C
C
 980  CONTINUE
      WRITE(*,9500) FILNAM(1:64), ILINE
 9800 FORMAT(/&#39; Fewer parameters than required&#39;
     &amp;       /&#39;   in file:  &#39;, A
     &amp;       /&#39;   line&#39;,I3)
      STOP
C
      END ! QPROP
         
</pre></div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./qprop"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="qprop-algorithms.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">QProp Algorithms</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="qcget_f.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">qcget.f</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Roie R. Black<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>